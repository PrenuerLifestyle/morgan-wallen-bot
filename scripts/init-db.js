require('dotenv').config();
const{Pool}=require('pg');
const pool=new Pool({connectionString:process.env.DATABASE_URL,ssl:process.env.NODE_ENV==='production'?{rejectUnauthorized:false}:false});
async function init(){console.log('üîÑ Initializing database...');try{await pool.query('SELECT NOW()');console.log('‚úÖ Connected');await pool.query(`CREATE TABLE IF NOT EXISTS users(id SERIAL PRIMARY KEY,telegram_id BIGINT UNIQUE NOT NULL,username VARCHAR(255),first_name VARCHAR(255),last_name VARCHAR(255),email VARCHAR(255),phone VARCHAR(50),membership_tier VARCHAR(50)DEFAULT'free',membership_expires TIMESTAMP,stripe_customer_id VARCHAR(255),total_spent DECIMAL(10,2)DEFAULT 0,created_at TIMESTAMP DEFAULT NOW(),last_active TIMESTAMP DEFAULT NOW());CREATE TABLE IF NOT EXISTS admins(id SERIAL PRIMARY KEY,telegram_id BIGINT UNIQUE NOT NULL,email VARCHAR(255),password_hash VARCHAR(255),role VARCHAR(50)DEFAULT'admin',created_at TIMESTAMP DEFAULT NOW());CREATE TABLE IF NOT EXISTS bookings(id SERIAL PRIMARY KEY,user_id INTEGER REFERENCES users(id),booking_type VARCHAR(50)NOT NULL,booking_date TIMESTAMP,duration INTEGER DEFAULT 15,status VARCHAR(50)DEFAULT'pending',payment_status VARCHAR(50)DEFAULT'unpaid',amount DECIMAL(10,2),stripe_payment_id VARCHAR(255),zoom_meeting_url TEXT,created_at TIMESTAMP DEFAULT NOW());CREATE TABLE IF NOT EXISTS tours(id SERIAL PRIMARY KEY,city VARCHAR(255)NOT NULL,state VARCHAR(100),venue VARCHAR(255)NOT NULL,date TIMESTAMP NOT NULL,tickets_available INTEGER DEFAULT 0,tickets_sold INTEGER DEFAULT 0,ticket_price DECIMAL(10,2),vip_price DECIMAL(10,2),status VARCHAR(50)DEFAULT'active',created_at TIMESTAMP DEFAULT NOW());CREATE INDEX IF NOT EXISTS idx_users_telegram ON users(telegram_id);CREATE INDEX IF NOT EXISTS idx_bookings_user ON bookings(user_id);`);console.log('‚úÖ Database initialized!');}catch(e){console.error('‚ùå',e.message);}finally{await pool.end();}}init();
